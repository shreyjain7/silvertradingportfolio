<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Silver Position Manager + AI</title>
    <!-- Chart.js for Graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Markdown Parser for AI response -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            /* TradingView-inspired Palette */
            --bg-color: #131722;
            --card-bg: #1e222d;
            --input-bg: #2a2e39;
            --border: #363a45;
            --text-main: #d1d4dc;
            --text-muted: #787b86;
            
            --tv-blue: #2962ff;
            --tv-green: #26a69a;
            --tv-red: #ef5350;
            --tv-green-transparent: rgba(38, 166, 154, 0.15);
            --tv-red-transparent: rgba(239, 83, 80, 0.15);
            
            --success: #26a69a;
            --danger: #ef5350;
            --warning: #f59e0b;
        }

        * { box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Trebuchet MS", Roboto, Ubuntu, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 1000px;
            display: grid;
            grid-template-columns: 1fr 350px; /* Dashboard Layout */
            gap: 20px;
            align-content: start;
        }

        /* Header spans full width */
        header {
            grid-column: 1 / -1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 10px;
        }
        
        h1 { margin: 0; font-size: 1.5rem; font-weight: 600; }
        .subtitle { color: var(--text-muted); font-size: 0.9rem; }

        /* Cards */
        .card {
            background-color: var(--card-bg);
            border-radius: 4px;
            padding: 20px;
            border: 1px solid var(--border);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        /* Titles within cards */
        .card-title {
            font-size: 0.95rem;
            color: var(--text-main);
            margin: 0 0 15px 0;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* News Styles */
        .news-content {
            font-size: 0.85rem;
            line-height: 1.5;
            color: var(--text-main);
        }
        .news-content h3 { font-size: 1rem; color: var(--tv-blue); margin-top: 0; }
        .news-content ul { padding-left: 20px; margin: 10px 0; }
        .news-content li { margin-bottom: 8px; }
        .refresh-btn {
            background: none;
            border: none;
            color: var(--tv-blue);
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .refresh-btn:hover { text-decoration: underline; }

        /* Live Price Ticker */
        .live-ticker {
            background: rgba(41, 98, 255, 0.1);
            border: 1px solid var(--tv-blue);
            color: var(--tv-blue);
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .live-ticker:hover {
            background: rgba(41, 98, 255, 0.2);
        }
        .live-dot {
            height: 8px;
            width: 8px;
            background-color: var(--tv-blue);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(41, 98, 255, 0.4); }
            70% { box-shadow: 0 0 0 6px rgba(41, 98, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(41, 98, 255, 0); }
        }

        /* AI Button */
        .btn-ai {
            background: linear-gradient(135deg, #2962ff, #7c4dff);
            color: white;
            border: none;
            padding: 6px 16px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 5px rgba(124, 77, 255, 0.3);
            transition: transform 0.1s;
        }
        .btn-ai:hover { transform: translateY(-1px); box-shadow: 0 4px 8px rgba(124, 77, 255, 0.4); }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 100;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(2px);
        }
        .modal-content {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 8px;
            width: 90%; max-width: 500px;
            border: 1px solid var(--border);
            position: relative;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            max-height: 90vh;
            overflow-y: auto;
        }
        .close-modal {
            position: absolute;
            top: 15px; right: 15px;
            background: none; border: none;
            color: var(--text-muted);
            font-size: 1.5rem; cursor: pointer;
        }
        .ai-response {
            background: rgba(41, 98, 255, 0.05);
            border: 1px solid var(--border);
            padding: 15px;
            border-radius: 4px;
            margin-top: 15px;
            font-size: 0.9rem;
            line-height: 1.6;
            min-height: 50px;
            color: #e0e0e0;
        }
        .ai-response p { margin-top: 0; }
        .ai-response strong { color: var(--tv-blue); }

        /* --- INPUT SECTION (Left Column) --- */
        .input-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .input-wrapper {
            display: flex;
            flex-direction: column;
            gap: 6px;
            position: relative;
        }

        label {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        input, textarea {
            background-color: var(--bg-color); /* Darker than card */
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 10px;
            border-radius: 4px;
            font-size: 0.9rem;
            outline: none;
            transition: border-color 0.2s;
            width: 100%;
        }

        input:focus, textarea:focus {
            border-color: var(--tv-blue);
        }

        input::placeholder, textarea::placeholder { color: #434651; }

        .btn-add {
            background-color: var(--tv-blue);
            color: white;
            width: 100%;
            padding: 12px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: background 0.2s;
        }
        .btn-add:hover { background-color: #1e53e5; }
        .btn-add:disabled { opacity: 0.6; cursor: wait; }

        /* --- SUMMARY SECTION (Right Column) --- */
        .summary-column {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            font-size: 0.9rem;
        }
        
        .stat-row.large {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
        }

        .stat-label { color: var(--text-muted); }
        .stat-value { font-weight: 600; color: var(--text-main); }
        
        .avg-price { 
            font-size: 1.8rem; 
            color: var(--tv-blue); 
            font-weight: 700;
        }

        /* P&L Calculator Area */
        .pnl-section {
            background: rgba(255,255,255,0.02);
            border-radius: 4px;
            padding: 15px;
            margin-top: 10px;
        }
        
        .btn-use-live {
            position: absolute;
            right: 0;
            top: 0;
            font-size: 0.7rem;
            color: var(--tv-blue);
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
        }
        .btn-use-live:hover { text-decoration: underline; }

        .pnl-display {
            font-size: 1.2rem;
            font-weight: 700;
            text-align: right;
            margin-top: 10px;
        }
        
        .pnl-percent {
            font-size: 0.85rem;
            text-align: right;
            font-weight: 500;
        }

        .text-green { color: var(--tv-green); }
        .text-red { color: var(--tv-red); }
        .bg-green { background-color: var(--tv-green-transparent); }
        .bg-red { background-color: var(--tv-red-transparent); }

        /* --- HISTORY & CHART --- */
        .chart-container {
            height: 250px;
            width: 100%;
            margin-bottom: 20px;
        }

        .table-container {
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        th {
            text-align: left;
            color: var(--text-muted);
            font-weight: 500;
            padding: 12px 10px;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            background-color: var(--card-bg);
            z-index: 10;
        }

        td {
            padding: 10px;
            border-bottom: 1px solid var(--border);
            color: var(--text-main);
        }

        tr:hover td { background-color: rgba(255,255,255,0.02); }

        /* Buttons */
        .btn-icon {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px 8px;
            font-size: 1.1rem;
        }
        .btn-icon:hover { color: var(--tv-red); }

        .btn-reset {
            background: none;
            border: 1px solid var(--border);
            color: var(--text-muted);
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
        }
        .btn-reset:hover { border-color: var(--tv-red); color: var(--tv-red); }
        .btn-reset.confirm { background: var(--tv-red); color: white; border-color: var(--tv-red); }

        .error-msg {
            color: var(--tv-red);
            font-size: 0.8rem;
            margin-top: 8px;
            display: none;
        }

        /* Gradient border for AI card */
        .ai-card {
            background: linear-gradient(var(--card-bg), var(--card-bg)) padding-box,
                        linear-gradient(135deg, #2962ff, #7c4dff) border-box;
            border: 1px solid transparent;
            border-radius: 6px;
        }

        /* Mobile Layout */
        @media (max-width: 768px) {
            .container { grid-template-columns: 1fr; }
            .input-grid { grid-template-columns: 1fr; }
            .chart-container { height: 200px; }
            .summary-column { order: -1; } /* Summary first on mobile */
            header { flex-direction: column; align-items: flex-start; gap: 10px; }
            .live-ticker { align-self: stretch; justify-content: center; }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div>
            <h1>Silver Manager</h1>
            <div class="subtitle">Position & PnL Calculator</div>
        </div>
        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
             <div class="live-ticker" id="livePriceTicker" onclick="fetchLivePrice()" title="Click to Refresh">
                <div class="live-dot"></div>
                <span id="livePriceText">Loading Silver...</span>
            </div>
            <button class="btn-ai" onclick="openAIModal()">
                ‚ú® AI Assistant
            </button>
            <button id="resetBtn" onclick="handleReset()" class="btn-reset">Reset</button>
        </div>
    </header>

    <!-- LEFT COLUMN: Main Inputs & Data -->
    <div style="display: flex; flex-direction: column; gap: 20px;">
        
        <!-- ‚ú® AI Quick Add Card -->
        <div class="card ai-card">
            <h3 class="card-title" style="color: white; margin-bottom:10px;">‚ú® AI Quick Add</h3>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <input type="text" id="aiInput" placeholder="e.g. Bought 500g at 72k" style="flex-grow:1; border: 1px solid rgba(124, 77, 255, 0.5);">
                <button onclick="runGeminiAnalysis('parse')" class="btn-ai" id="btnParse">Auto-Fill</button>
            </div>
            <div id="aiParseFeedback" style="font-size: 0.75rem; color: var(--tv-green); margin-top: 5px; height: 1.2em;"></div>
        </div>

        <!-- Input Card -->
        <div class="card">
            <h3 class="card-title">Add New Trade</h3>
            <div class="input-grid">
                <div class="input-wrapper">
                    <label>Entry Price (‚Çπ/kg)</label>
                    <input type="number" id="priceInput" placeholder="e.g. 75000" step="any">
                </div>
                <div class="input-wrapper">
                    <label>Quantity (kg)</label>
                    <input type="number" id="qtyInput" placeholder="e.g. 1.5" step="any">
                </div>
            </div>
            <button onclick="addTrade()" class="btn-add">Add to Position</button>
            <div id="errorMsg" class="error-msg">Please enter valid values</div>
        </div>

        <!-- Chart Card -->
        <div class="card" id="graphCard">
            <h3 class="card-title">Average Trend</h3>
            <div class="chart-container">
                <canvas id="tradeChart"></canvas>
            </div>
        </div>

        <!-- News Card -->
        <div class="card">
            <h3 class="card-title">
                <span>üì∞ Silver Market News</span>
                <button class="refresh-btn" onclick="fetchSilverNews()">
                    <span id="newsIcon">‚Üª</span> Refresh
                </button>
            </h3>
            <div id="newsContainer" class="news-content">
                <div style="color: var(--text-muted); font-style: italic; text-align: center; padding: 20px;">
                    Click "Refresh" to load the latest Silver market insights using Gemini AI.
                </div>
            </div>
        </div>

        <!-- History Card -->
        <div class="card">
            <h3 class="card-title">Trade History</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Entry Price</th>
                            <th>Qty</th>
                            <th>Amount</th>
                            <th style="text-align: right;">Action</th>
                        </tr>
                    </thead>
                    <tbody id="tradeList"></tbody>
                </table>
                <div id="emptyState" style="text-align: center; padding: 30px; color: var(--text-muted); font-style: italic;">
                    No trades added
                </div>
            </div>
        </div>
    </div>

    <!-- RIGHT COLUMN: Summary & Stats -->
    <div class="summary-column">
        <div class="card" style="position: sticky; top: 20px;">
            <h3 class="card-title">Summary</h3>
            
            <div style="margin-bottom: 20px; text-align: center;">
                <div class="stat-label" style="margin-bottom: 5px;">Average Buy Price</div>
                <div class="avg-price" id="avgPrice">‚Çπ0.00</div>
            </div>

            <div class="stat-row">
                <span class="stat-label">Total Quantity (kg)</span>
                <span class="stat-value" id="totalQty">0</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Invested Amount</span>
                <span class="stat-value" id="totalAmt">‚Çπ0.00</span>
            </div>

            <!-- P&L Calculator -->
            <div class="pnl-section">
                <div class="input-wrapper">
                    <label style="color: var(--tv-blue);">Current Market Price (‚Çπ/kg)</label>
                    <button type="button" class="btn-use-live" onclick="useLivePrice()">Use Live</button>
                    <input type="number" id="cmpInput" placeholder="Enter CMP..." step="any" oninput="calculatePnL()">
                </div>
                
                <div class="stat-row large">
                    <span class="stat-label">Unrealized P&L</span>
                </div>
                <div class="pnl-display" id="pnlValue">‚Çπ0.00</div>
                <div class="pnl-percent" id="pnlPercent">0.00%</div>
            </div>
        </div>
    </div>

    <footer style="grid-column: 1 / -1; text-align: center; margin-top: 10px; padding-top: 20px; border-top: 1px solid var(--border); color: var(--text-muted); font-size: 0.8rem;">
        No Copyrights ‚Ä¢ Shrey Jain
    </footer>

</div>

<!-- AI Modal -->
<div id="aiModal" class="modal">
    <div class="modal-content">
        <button class="close-modal" onclick="closeAIModal()">√ó</button>
        <h3 class="card-title">Gemini AI Command Center</h3>
        
        <div class="input-wrapper" style="margin-bottom: 15px;">
            <label>Gemini API Key</label>
            <input type="password" id="apiKeyInput" placeholder="Enter your Gemini API Key">
            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 5px;">
                Using Default Key unless overridden.
            </div>
        </div>

        <!-- Tabs or Sections -->
        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            <button onclick="runGeminiAnalysis('position')" class="btn-add" id="btnAnalyze" style="flex: 1;">Analyze My Position</button>
        </div>
        
        <div class="input-wrapper" style="margin-bottom: 10px; padding-top: 10px; border-top: 1px solid var(--border);">
            <label>Ask the Expert (Strategy Coach)</label>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="aiCustomQuery" placeholder="e.g. How do I hedge this position?">
                <button onclick="runGeminiAnalysis('custom')" class="btn-ai" id="btnCustom" style="white-space: nowrap;">Ask</button>
            </div>
        </div>

        <div id="aiResult" class="ai-response" style="display:none;"></div>
    </div>
</div>

<script>
    // --- Configuration ---
    const DEFAULT_API_KEY = "AIzaSyBGO40XXrSEKPg9lwS6WIo31LMK42NVMqY";

    // --- State Management ---
    let trades = JSON.parse(localStorage.getItem('tvTrades')) || [];
    let chartInstance = null;
    let resetTimer = null;
    let currentLivePrice = 0;

    // --- Initialization ---
    updateUI();
    fetchLivePrice();
    
    // Check if key exists (or default exists) and auto-load news
    if(localStorage.getItem('geminiApiKey') || DEFAULT_API_KEY) {
        // Slight delay to ensure UI is ready
        setTimeout(fetchSilverNews, 1000); 
    }

    // Refresh price every 60 seconds
    setInterval(fetchLivePrice, 60000);

    // --- AI Features ---
    function openAIModal() {
        document.getElementById('aiModal').style.display = 'flex';
        const savedKey = localStorage.getItem('geminiApiKey');
        // Pre-fill with saved key, or default key if not saved
        document.getElementById('apiKeyInput').value = savedKey || DEFAULT_API_KEY;
    }

    function closeAIModal() {
        document.getElementById('aiModal').style.display = 'none';
        document.getElementById('aiResult').style.display = 'none';
    }

    // Unified Gemini Caller
    async function runGeminiAnalysis(mode) {
        const apiKeyInput = document.getElementById('apiKeyInput');
        let apiKey = apiKeyInput.value.trim();
        
        // Priority: 1. Input Field -> 2. Local Storage -> 3. Default Key
        if (!apiKey) apiKey = localStorage.getItem('geminiApiKey');
        if (!apiKey) apiKey = DEFAULT_API_KEY;

        if(!apiKey) {
            alert("Please enter a valid API Key to use AI features.");
            return;
        }
        
        // Only save to local storage if it's different from default and user typed it
        if (apiKey !== DEFAULT_API_KEY && apiKeyInput.value.trim()) {
            localStorage.setItem('geminiApiKey', apiKey);
        }

        let prompt = "";
        let resultContainerId = "";
        let btnId = "";
        
        // --- PROMPT ENGINEERING ---
        const avg = window.currentAvg.toFixed(2);
        const qty = window.currentQty;
        const total = (window.currentAvg * window.currentQty).toFixed(2);
        const cmp = parseFloat(document.getElementById('cmpInput').value) || currentLivePrice || 0;
        const cmpDisplay = cmp > 0 ? `‚Çπ${cmp.toFixed(2)}` : "Unknown";
        const portfolioContext = `Portfolio: Qty: ${qty} kg, Avg Buy: ‚Çπ${avg}/kg, Total: ‚Çπ${total}, CMP: ${cmpDisplay}/kg.`;

        if (mode === 'position') {
            resultContainerId = "aiResult";
            btnId = "btnAnalyze";
            prompt = `
            I am a trader in India trading Silver (Symbol: XAG/INR). 
            ${portfolioContext}
            
            Provide a brief analysis:
            1. Is my average price competitive vs current market?
            2. Current Silver market sentiment (Bullish/Bearish)?
            3. Suggest a risk management strategy.
            Format as concise Markdown.
            `;
        } else if (mode === 'news') {
            resultContainerId = "newsContainer";
            btnId = "newsIcon"; 
            prompt = `
            Summarize the top 3 critical news headlines, economic indicators (like CPI, Fed rates), or geopolitical events affecting Silver (XAG) prices right now. 
            Focus on the Indian market perspective if relevant.
            Format as a clean Markdown list. Keep it short and actionable.
            `;
        } else if (mode === 'parse') {
            resultContainerId = "aiParseFeedback";
            btnId = "btnParse";
            const userText = document.getElementById('aiInput').value;
            prompt = `
            You are a data extraction bot. Extract trade details from this text: "${userText}".
            The user tracks silver in KG (kilograms) and INR (Rupees).
            
            Rules:
            1. Convert all weights to KG (e.g., 500g -> 0.5, 1000 grams -> 1, 2 kg -> 2).
            2. Extract price as a plain number (e.g. 72k -> 72000, 72,000 -> 72000).
            3. Return ONLY a JSON object: { "qty": number, "price": number }.
            4. If the text is not about a trade or unclear, return { "error": true }.
            `;
        } else if (mode === 'custom') {
            resultContainerId = "aiResult";
            btnId = "btnCustom";
            const customQ = document.getElementById('aiCustomQuery').value;
            prompt = `
            I am a silver trader. ${portfolioContext}
            My Question: "${customQ}"
            
            Answer as an expert commodities trading coach. Be concise and practical. Use Markdown.
            `;
        }

        const resultDiv = document.getElementById(resultContainerId);
        const btn = document.getElementById(btnId);
        
        // Loading State
        if (mode === 'parse') {
            btn.innerText = "‚è≥";
            btn.disabled = true;
            resultDiv.innerText = "Processing...";
        } else if (mode !== 'news') {
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = "<span style='color:var(--text-muted)'>Connecting to Gemini...</span>";
            btn.disabled = true;
            btn.innerText = "Thinking...";
        } else {
            resultDiv.innerHTML = "<span style='color:var(--text-muted)'>Fetching latest market insights...</span>";
        }

        // --- API CALL ---
        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseMimeType: mode === 'parse' ? "application/json" : "text/plain"
                    }
                })
            });

            const data = await response.json();
            
            if(data.error) {
                if (mode === 'parse') {
                     resultDiv.innerText = "Error: " + data.error.message;
                } else {
                    resultDiv.innerHTML = `<span style="color:var(--tv-red)">Error: ${data.error.message}</span>`;
                }
            } else {
                const text = data.candidates[0].content.parts[0].text;
                
                if (mode === 'parse') {
                    // Handle JSON Extraction
                    const result = JSON.parse(text);
                    if (result.error || !result.price || !result.qty) {
                        resultDiv.innerText = "Could not understand. Try 'Bought 1kg at 72000'";
                        resultDiv.style.color = "var(--danger)";
                    } else {
                        // Auto-Fill
                        document.getElementById('priceInput').value = result.price;
                        document.getElementById('qtyInput').value = result.qty;
                        resultDiv.innerText = `Auto-filled: ${result.qty}kg @ ‚Çπ${result.price}`;
                        resultDiv.style.color = "var(--tv-green)";
                        document.getElementById('aiInput').value = ""; // Clear input
                    }
                } else {
                    // Handle Text Response
                    resultDiv.innerHTML = marked.parse(text);
                }
            }
        } catch (err) {
             if (mode === 'parse') {
                 resultDiv.innerText = "Network Error";
             } else {
                 resultDiv.innerHTML = `<span style="color:var(--tv-red)">Network Error: ${err.message}</span>`;
             }
        } finally {
            // Restore Buttons
            if (btn) {
                btn.disabled = false;
                if (mode === 'position') btn.innerText = "Analyze My Position";
                else if (mode === 'custom') btn.innerText = "Ask";
                else if (mode === 'parse') btn.innerText = "Auto-Fill";
            }
        }
    }

    // Wrapper for the News Button
    function fetchSilverNews() {
        // Check if we have a usable key (Storage or Default)
        const hasKey = localStorage.getItem('geminiApiKey') || DEFAULT_API_KEY;
        
        if (!hasKey) {
            // If no key, open modal to ask for it
            openAIModal();
            document.getElementById('aiResult').style.display = 'block';
            document.getElementById('aiResult').innerHTML = "Please enter your API Key first to fetch news.";
        } else {
            runGeminiAnalysis('news');
        }
    }

    // --- API Logic for Silver Price ---
    async function fetchLivePrice() {
        const tickerText = document.getElementById('livePriceText');
        if(tickerText.innerText.includes("Loading") || tickerText.innerText.includes("Offline")) {
            tickerText.innerText = "Updating...";
        }
        
        // List of APIs to try in order
        const urls = [
            'https://open.er-api.com/v6/latest/USD',
            'https://api.exchangerate-api.com/v4/latest/USD'
        ];

        let data = null;
        let success = false;

        for (const url of urls) {
            try {
                const response = await fetch(url);
                if (!response.ok) continue;
                data = await response.json();
                
                // Validate data exists
                if (data && data.rates && data.rates.INR) {
                    // We need at least INR rate. XAG might be missing in some backups.
                    success = true;
                    break; 
                }
            } catch (e) {
                console.warn(`API failed: ${url}`, e);
            }
        }

        if (success && data) {
            const rateINR = data.rates.INR;
            const rateXAG = data.rates.XAG;

            if (rateXAG) {
                // We have silver data
                const pricePerOz = rateINR / rateXAG;
                const pricePerKg = pricePerOz * 32.1507;
                currentLivePrice = pricePerKg;
                
                const formatted = new Intl.NumberFormat('en-IN', {
                    style: 'currency', 
                    currency: 'INR',
                    maximumFractionDigits: 0
                }).format(pricePerKg);
                
                tickerText.innerText = `Silver: ${formatted}/kg`;
                tickerText.style.color = 'var(--tv-blue)';
            } else {
                // Backup API might not have XAG
                if(currentLivePrice === 0) tickerText.innerText = "Silver Data Unavailable";
            }
        } else {
            // All APIs failed
            if (currentLivePrice === 0) {
                tickerText.innerText = "Price Offline";
                tickerText.style.color = 'var(--tv-red)';
            }
        }
    }

    function useLivePrice() {
        if (currentLivePrice > 0) {
            const cmpInput = document.getElementById('cmpInput');
            cmpInput.value = currentLivePrice.toFixed(2);
            calculatePnL();
            
            // Visual feedback
            cmpInput.style.borderColor = 'var(--tv-blue)';
            setTimeout(() => cmpInput.style.borderColor = 'var(--border)', 500);
        } else {
            alert("Live price not available yet. Please wait.");
        }
    }

    // --- Core Functions ---
    function addTrade() {
        const priceInput = document.getElementById('priceInput');
        const qtyInput = document.getElementById('qtyInput');
        const errorMsg = document.getElementById('errorMsg');

        const price = parseFloat(priceInput.value);
        const qty = parseFloat(qtyInput.value);

        if (!price || !qty || qty <= 0 || price < 0) {
            errorMsg.style.display = 'block';
            return;
        }

        errorMsg.style.display = 'none';

        const trade = {
            id: Date.now(),
            price: price,
            qty: qty,
            total: price * qty
        };

        trades.push(trade);
        saveAndRender();
        
        priceInput.value = '';
        qtyInput.value = '';
        priceInput.focus();
    }

    function removeTrade(id) {
        trades = trades.filter(t => t.id !== id);
        saveAndRender();
    }

    function handleReset() {
        const btn = document.getElementById('resetBtn');
        if (btn.classList.contains('confirm')) {
            trades = [];
            document.getElementById('cmpInput').value = ''; // Clear CMP
            saveAndRender();
            resetButtonState();
        } else {
            btn.classList.add('confirm');
            btn.innerText = "Confirm?";
            if (resetTimer) clearTimeout(resetTimer);
            resetTimer = setTimeout(resetButtonState, 3000);
        }
    }

    function resetButtonState() {
        const btn = document.getElementById('resetBtn');
        btn.classList.remove('confirm');
        btn.innerText = "Reset";
        resetTimer = null;
    }

    function saveAndRender() {
        localStorage.setItem('tvTrades', JSON.stringify(trades));
        updateUI();
    }

    // --- UI Update & Logic ---
    function updateUI() {
        const list = document.getElementById('tradeList');
        const emptyState = document.getElementById('emptyState');
        const graphCard = document.getElementById('graphCard');
        
        let totalQty = 0;
        let totalAmt = 0;

        list.innerHTML = '';

        if (trades.length === 0) {
            emptyState.style.display = 'block';
            graphCard.style.display = 'none';
        } else {
            emptyState.style.display = 'none';
            graphCard.style.display = 'block';

            // Show newest first
            trades.slice().reverse().forEach(trade => {
                totalQty += trade.qty;
                totalAmt += trade.total;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="color: var(--text-main); font-weight: 500;">${formatMoney(trade.price)}</td>
                    <td>${trade.qty}</td>
                    <td style="color: var(--text-muted);">${formatMoney(trade.total)}</td>
                    <td style="text-align: right;">
                        <button onclick="removeTrade(${trade.id})" class="btn-icon">√ó</button>
                    </td>
                `;
                list.appendChild(row);
            });
            renderChart();
        }

        // Stats
        const avgPrice = totalQty > 0 ? (totalAmt / totalQty) : 0;
        
        document.getElementById('totalQty').innerText = parseFloat(totalQty.toFixed(4));
        document.getElementById('totalAmt').innerText = formatMoney(totalAmt);
        document.getElementById('avgPrice').innerText = formatMoney(avgPrice);

        // Store globals for P&L calc
        window.currentAvg = avgPrice;
        window.currentQty = totalQty;
        
        // Recalculate P&L if CMP is present
        calculatePnL();
    }

    // --- Profit/Loss Calculation ---
    function calculatePnL() {
        const cmp = parseFloat(document.getElementById('cmpInput').value);
        const pnlValueEl = document.getElementById('pnlValue');
        const pnlPercentEl = document.getElementById('pnlPercent');
        
        if (!cmp || !window.currentQty || window.currentQty === 0) {
            pnlValueEl.innerText = '‚Çπ0.00';
            pnlPercentEl.innerText = '0.00%';
            pnlValueEl.className = 'pnl-display';
            pnlPercentEl.className = 'pnl-percent';
            return;
        }

        const avg = window.currentAvg;
        const diff = cmp - avg;
        const totalPnL = diff * window.currentQty;
        const percentPnL = (diff / avg) * 100;

        // Styling
        const isProfit = totalPnL >= 0;
        const colorClass = isProfit ? 'text-green' : 'text-red';
        const sign = isProfit ? '+' : '';

        pnlValueEl.innerText = `${sign}${formatMoney(totalPnL)}`;
        pnlPercentEl.innerText = `${sign}${percentPnL.toFixed(2)}%`;
        
        pnlValueEl.className = `pnl-display ${colorClass}`;
        pnlPercentEl.className = `pnl-percent ${colorClass}`;
    }

    // --- Chart.js ---
    function renderChart() {
        const ctx = document.getElementById('tradeChart').getContext('2d');
        const chronTrades = trades.slice().sort((a, b) => a.id - b.id);
        
        // Data Prep
        const labels = chronTrades.map((_, i) => i + 1);
        const buyPrices = chronTrades.map(t => t.price);
        
        let rQty = 0, rTot = 0;
        const avgs = chronTrades.map(t => {
            rQty += t.qty;
            rTot += t.total;
            return rTot / rQty;
        });

        if (chartInstance) chartInstance.destroy();

        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Avg Price',
                        data: avgs,
                        borderColor: '#2962ff',
                        borderWidth: 2,
                        fill: true,
                        backgroundColor: (context) => {
                            const ctx = context.chart.ctx;
                            const gradient = ctx.createLinearGradient(0, 0, 0, 300);
                            gradient.addColorStop(0, 'rgba(41, 98, 255, 0.3)');
                            gradient.addColorStop(1, 'rgba(41, 98, 255, 0.0)');
                            return gradient;
                        },
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 6
                    },
                    {
                        label: 'Entry',
                        data: buyPrices,
                        borderColor: '#787b86',
                        borderWidth: 1,
                        borderDash: [4, 4],
                        pointRadius: 3,
                        pointBackgroundColor: '#1e222d',
                        tension: 0.2
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: '#1e222d',
                        titleColor: '#d1d4dc',
                        bodyColor: '#d1d4dc',
                        borderColor: '#363a45',
                        borderWidth: 1,
                        padding: 10,
                        callbacks: {
                            label: (ctx) => `${ctx.dataset.label}: ‚Çπ${ctx.raw.toFixed(2)}`
                        }
                    }
                },
                scales: {
                    x: {
                        display: false
                    },
                    y: {
                        position: 'right',
                        grid: {
                            color: '#2a2e39',
                            drawBorder: false
                        },
                        ticks: {
                            color: '#787b86',
                            font: { size: 10 },
                            callback: (val) => '‚Çπ' + val
                        }
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                }
            }
        });
    }

    function formatMoney(num) {
        return new Intl.NumberFormat('en-IN', {
            style: 'currency',
            currency: 'INR',
            minimumFractionDigits: 2
        }).format(num);
    }

    // Input Listeners
    document.getElementById('qtyInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') addTrade();
    });
    document.getElementById('priceInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') document.getElementById('qtyInput').focus();
    });
    // Add listener for AI input
    document.getElementById('aiInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') runGeminiAnalysis('parse');
    });
</script>

</body>
</html>
